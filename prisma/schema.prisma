// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  SYSTEM_ADMIN
  PROPERTY_MANAGER
  TENANT
  VENDOR
  ALL
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  UNDER_REVIEW
}

model MaintenanceRequest {
  id             String        @id @default(uuid())
  organizationId String
  propertyId     String
  requestedById  String        // The user who created the request (tenant or property manager)
  title          String
  description    String
  priority       Priority      @default(NORMAL)
  status         RequestStatus @default(OPEN)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization   Organization     @relation(fields: [organizationId], references: [id])
  property       Property         @relation(fields: [propertyId], references: [id])
  requestedBy    OrganizationUser @relation("RequestCreator", fields: [requestedById], references: [id])

  @@index([organizationId])
  @@index([propertyId])
  @@index([requestedById])
}

model Tenantapplication {
  id                 String             @id @default(uuid())
  fullName           String
  email              String
  phone              String
  dob                DateTime
  ssn                String?
  address            String?
  employerName       String?
  jobTitle           String?
  monthlyIncome      Float?
  employmentDuration String?
  leaseType          String
  occupancyType      String
  moveInDate         DateTime
  leaseDuration      String
  occupants          Int?
  pets               String?
  landlordName       String?
  landlordContact    String?
  reasonForMoving    String?
  referenceName      String?
  referenceContact   String?
  consent            Boolean            @default(false)
  propertyId         String
  userId             String?
  status             ApplicationStatus  @default(PENDING)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  // Relations
  property           Property           @relation(fields: [propertyId], references: [id])
  user              User?              @relation(fields: [userId], references: [id])
}

model Organization {
  id         String   @id @default(uuid())
  name       String
  slug       String   @unique
  logoUrl    String?  @map("logo_url")
  website    String?
  phone      String?
  address    String?
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  planId     Int?

  // Relations
  invites             Invite[]
  users               OrganizationUser[]
  listings            Listing[]
  vendors             Vendor[]
  properties          Property[]           @relation("OrganizationToProperty")
  maintenanceRequests MaintenanceRequest[]
  plan                Plan?                @relation(fields: [planId], references: [id])

  @@index([planId], map: "organizations_planId_fkey")
  @@map("organizations")
}

model User {
  id            String     @id @default(uuid())
  email         String     @unique
  passwordHash  String     @map("password_hash")
  emailVerified Boolean    @default(false) @map("email_verified")
  firstName     String?    @map("first_name")
  lastName      String?    @map("last_name")
  phone         String?
  avatarUrl     String?    @map("avatar_url")
  status        UserStatus @default(ACTIVE)
  lastLoginAt   DateTime?  @map("last_login_at")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  organizationUsers OrganizationUser[]
  vendors          Vendor[]
  sentInvites      Invite[]           @relation("UserInvites")
  listings         Listing[]
  tenantApplications Tenantapplication[]

  @@map("users")
}

model OrganizationUser {
  id                String               @id @default(uuid())
  userId            String               @map("user_id")
  organizationId    String               @map("organization_id")
  role              UserRole
  createdAt         DateTime             @default(now()) @map("created_at")
  organization      Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  managedProperties Property[]
  postedServices    ServiceMarketplace[]
  adminActions      AdminAction[]        @relation("AdminActionsByAdmin")
  targetActions     AdminAction[]        @relation("AdminActionsTarget")
  createdRequests   MaintenanceRequest[] @relation("RequestCreator")

  @@unique([userId, organizationId])
  @@index([organizationId], map: "organization_users_organization_id_fkey")
  @@map("organization_users")
}

model Property {
  id                  String   @id @default(uuid())
  listingId           String?  @unique
  managerId           String?
  name                String?
  organizationId      String?
  propertyTypeId      String?
  locationId          String?
  city                String
  address             String
  bedrooms            Int?
  bathrooms           Int?
  size                Float?
  amenities           String?
  isFurnished         Boolean  @default(false)
  availabilityStatus  String?
  createdAt           DateTime @default(now())

  // Relations
  listing             Listing?          @relation(fields: [listingId], references: [id])
  manager             OrganizationUser? @relation(fields: [managerId], references: [id])
  organization        Organization?     @relation("OrganizationToProperty", fields: [organizationId], references: [id])
  propertyType        PropertyType?     @relation(fields: [propertyTypeId], references: [id])
  location            Location?         @relation(fields: [locationId], references: [id])
  appliances          Appliance[]       @relation("PropertyAppliances")
  maintenanceRequests MaintenanceRequest[]
  tenantApplications  Tenantapplication[]
  apartmentComplexDetail ApartmentComplexDetail?
  houseDetail         HouseDetail?

  @@index([locationId])
  @@index([managerId])
  @@index([organizationId])
  @@index([propertyTypeId])
}

model Vendor {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  companyName    String       @map("company_name")
  serviceType    String       @map("service_type")
  phone          String?
  email          String?
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([organizationId, userId])
  @@index([userId], map: "vendors_user_id_fkey")
  @@map("vendors")
}

model CategoryMarketplace {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  listings    Listing[]
}

model ListingType {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  listings    Listing[]
}

model ListingStatus {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  listings    Listing[]
}

model PropertyType {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  properties  Property[]
}

model ServiceType {
  id                 String               @id @default(uuid())
  name               String               @unique
  description        String?
  createdAt          DateTime             @default(now())
  serviceMarketplace ServiceMarketplace[]
}

model Location {
  id         String     @id @default(uuid())
  name       String
  city       String?
  country    String?
  createdAt  DateTime   @default(now())
  listings   Listing[]
  properties Property[]
}

model Listing {
  id             String   @id @default(uuid())
  organizationId String
  createdBy      String
  categoryId     String
  listingTypeId  String?
  statusId       String?
  locationId     String?
  title          String
  description    String
  price          Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization        Organization        @relation(fields: [organizationId], references: [id])
  createdByUser       User               @relation(fields: [createdBy], references: [id])
  categoryMarketPlace CategoryMarketplace @relation(fields: [categoryId], references: [id])
  listingType         ListingType?       @relation(fields: [listingTypeId], references: [id])
  status              ListingStatus?     @relation(fields: [statusId], references: [id])
  location            Location?          @relation(fields: [locationId], references: [id])
  property            Property?
  serviceMarketplace  ServiceMarketplace?
  images              ListingImage[]
  adminActions        AdminAction[]
}

model ServiceMarketplace {
  id            String   @id @default(uuid())
  listingId     String   @unique
  vendorId      String?
  serviceTypeId String?
  description   String
  rate          Float
  availability  String?
  createdAt     DateTime @default(now())

  listing     Listing           @relation(fields: [listingId], references: [id])
  vendor      OrganizationUser? @relation(fields: [vendorId], references: [id])
  serviceType ServiceType?      @relation(fields: [serviceTypeId], references: [id])
}

model ListingImage {
  id        String   @id @default(uuid())
  listingId String
  imageUrl  String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  listing Listing @relation(fields: [listingId], references: [id])
}

model ActionType {
  id           String        @id @default(uuid())
  name         String        @unique
  description  String?
  createdAt    DateTime      @default(now())
  adminActions AdminAction[]
}

model AdminAction {
  id              String   @id @default(uuid())
  adminOrgUserId  String
  targetOrgUserId String?
  listingId       String?
  actionTypeId    String
  reason          String?
  details         Json?
  createdAt       DateTime @default(now())

  admin      OrganizationUser  @relation("AdminActionsByAdmin", fields: [adminOrgUserId], references: [id])
  target     OrganizationUser? @relation("AdminActionsTarget", fields: [targetOrgUserId], references: [id])
  listing    Listing?          @relation(fields: [listingId], references: [id])
  actionType ActionType        @relation(fields: [actionTypeId], references: [id])
}

model Plan {
  id           Int           @id @default(autoincrement())
  name         String
  badge        String?
  monthlyPrice Float
  yearlyPrice  Float
  description  String?
  gradient     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime?     @default(now())
  features     Feature[]     @relation("PlanFeatures")
  sidebarItems SidebarItem[] @relation("SidebarItemPlans")
  organizations Organization[]
}

model Feature {
  id          Int           @id @default(autoincrement())
  key         String?       @unique
  title       String
  description String?
  path        String?
  icon        String?
  category    String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime?     @default(now())
  plans       Plan[]        @relation("PlanFeatures")
  sidebarItems SidebarItem[]
}

model SidebarItem {
  id          Int          @id @default(autoincrement())
  label       String
  path        String
  icon        String?
  section     String?
  order       Int?
  badge       String?
  description String?
  isActive    Boolean      @default(true)
  isExternal  Boolean      @default(false)
  target      String?
  featureId   Int?
  feature     Feature?     @relation(fields: [featureId], references: [id], onDelete: SetNull)
  plans       Plan[]       @relation("SidebarItemPlans")
  role        UserRole
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model NavbarItem {
  id          Int          @id @default(autoincrement())
  name        String
  href        String
  order       Int          @default(0)
  isVisible   Boolean      @default(true)
  isAvailable Boolean      @default(true)
  parentId    Int?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  parent      NavbarItem?  @relation("NavbarSubmenu", fields: [parentId], references: [id], onDelete: Cascade)
  children    NavbarItem[] @relation("NavbarSubmenu")

  @@index([parentId])
  @@index([order])
}

model ApartmentComplexDetail {
  id           String    @id @default(uuid())
  propertyId   String    @unique
  buildingName String?
  totalFloors  Int?
  totalUnits   Int?
  property     Property  @relation(fields: [propertyId], references: [id])
}

model HouseDetail {
  id             String   @id @default(uuid())
  propertyId     String   @unique
  numberOfFloors Int?
  property       Property @relation(fields: [propertyId], references: [id])
}

model Invite {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  role           UserRole
  organizationId String
  invitedById    String?
  expiresAt      DateTime
  accepted       Boolean      @default(false)
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
  invitedBy      User?       @relation("UserInvites", fields: [invitedById], references: [id])

  @@index([organizationId])
  @@index([email])
}

model Appliance {
  id          String     @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime   @default(now())
  properties  Property[] @relation("PropertyAppliances")
}